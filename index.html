<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoQuiz Lite</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Библиотека за компресиране на линковете -->
    <script src="https://unpkg.com/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <!-- Tailwind CSS за дизайн -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .draggable-item { touch-action: none; user-select: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useImperativeHandle, forwardRef } = React;

        // --- ПОМОЩНИ ФУНКЦИИ ---
        const getYouTubeId = (url) => {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- ИКОНИ ---
        const Icons = {
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>,
            Check: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
            Alert: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Clock: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Youtube: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"/><path d="m10 15 5-3-5-3z"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="15 19 12 22 9 19"/><line x1="12" x2="12" y1="2" y2="22"/><line x1="2" x2="22" y1="12" y2="12"/></svg>,
            Chat: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Star: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        };

        // --- УНИВЕРСАЛЕН МЕДИЯ ПЛЕЪР ---
        const MediaPlayer = forwardRef(({ url }, ref) => {
            const videoRef = useRef(null);
            const youtubePlayerRef = useRef(null);
            const [isYoutube, setIsYoutube] = useState(false);
            const [ytId, setYtId] = useState(null);
            const [apiReady, setApiReady] = useState(false);
            const playerId = useRef(`yt-player-${Math.random().toString(36).substr(2, 9)}`).current;

            useEffect(() => {
                const id = getYouTubeId(url);
                setYtId(id);
                setIsYoutube(!!id);
            }, [url]);

            useEffect(() => {
                if (isYoutube) {
                    if (window.YT && window.YT.Player) {
                        setApiReady(true);
                    } else if (!window.YT) {
                        const tag = document.createElement('script');
                        tag.src = "https://www.youtube.com/iframe_api";
                        const firstScriptTag = document.getElementsByTagName('script')[0];
                        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                        window.onYouTubeIframeAPIReady = () => setApiReady(true);
                    }
                }
            }, [isYoutube]);

            useEffect(() => {
                if (isYoutube && ytId && apiReady) {
                    if (youtubePlayerRef.current) {
                        try { youtubePlayerRef.current.destroy(); } catch(e) {}
                    }
                    setTimeout(() => {
                        youtubePlayerRef.current = new window.YT.Player(playerId, {
                            height: '100%',
                            width: '100%',
                            videoId: ytId,
                            playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1 }
                        });
                    }, 100);
                }
            }, [isYoutube, ytId, apiReady]);

            useImperativeHandle(ref, () => ({
                play: () => isYoutube ? youtubePlayerRef.current?.playVideo() : videoRef.current?.play(),
                pause: () => isYoutube ? youtubePlayerRef.current?.pauseVideo() : videoRef.current?.pause(),
                getTime: () => isYoutube ? (youtubePlayerRef.current?.getCurrentTime ? youtubePlayerRef.current.getCurrentTime() : 0) : (videoRef.current?.currentTime || 0)
            }));

            if (isYoutube) {
                return <div className="w-full h-full bg-black rounded-xl overflow-hidden relative"><div id={playerId} className="w-full h-full"></div></div>;
            }
            return <video ref={videoRef} src={url} controls className="w-full h-full object-contain bg-black rounded-xl" onError={() => {}} />;
        });

        // --- КОМПОНЕНТ ЗА ВЛАЧЕНЕ (ЕТИКЕТ) ---
        const DraggableLabel = ({ text, containerRef }) => {
            const [pos, setPos] = useState({ x: Math.random() * 60 + 20, y: Math.random() * 60 + 20 }); 
            const [isDragging, setIsDragging] = useState(false);
            const offset = useRef({ x: 0, y: 0 });

            const handleStart = (clientX, clientY) => {
                const rect = containerRef.current.getBoundingClientRect();
                const currentX = (pos.x / 100) * rect.width;
                const currentY = (pos.y / 100) * rect.height;
                offset.current = {
                    x: clientX - rect.left - currentX,
                    y: clientY - rect.top - currentY
                };
                setIsDragging(true);
            };

            useEffect(() => {
                if (!isDragging) return;

                const handleMove = (e) => {
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const rect = containerRef.current.getBoundingClientRect();
                    
                    let newX = clientX - rect.left - offset.current.x;
                    let newY = clientY - rect.top - offset.current.y;

                    // Boundaries
                    newX = Math.max(0, Math.min(newX, rect.width - 50));
                    newY = Math.max(0, Math.min(newY, rect.height - 30));

                    setPos({
                        x: (newX / rect.width) * 100,
                        y: (newY / rect.height) * 100
                    });
                };

                const handleEnd = () => setIsDragging(false);

                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);
                window.addEventListener('touchmove', handleMove);
                window.addEventListener('touchend', handleEnd);

                return () => {
                    window.removeEventListener('mousemove', handleMove);
                    window.removeEventListener('mouseup', handleEnd);
                    window.removeEventListener('touchmove', handleMove);
                    window.removeEventListener('touchend', handleEnd);
                };
            }, [isDragging]);

            return (
                <div 
                    onMouseDown={(e) => handleStart(e.clientX, e.clientY)}
                    onTouchStart={(e) => handleStart(e.touches[0].clientX, e.touches[0].clientY)}
                    className={`absolute px-4 py-2 bg-white/90 backdrop-blur border-2 border-blue-500 rounded-lg shadow-xl cursor-move font-bold text-slate-800 animate-pop select-none draggable-item z-50 ${isDragging ? 'scale-110 shadow-2xl ring-2 ring-blue-300' : ''}`}
                    style={{ left: `${pos.x}%`, top: `${pos.y}%`, transform: 'translate(-50%, -50%)' }}
                >
                    <div className="flex items-center gap-2">
                        <Icons.Move className="w-3 h-3 text-blue-400" />
                        {text}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('student');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [videoUrl, setVideoUrl] = useState('');
            const [questions, setQuestions] = useState([]);
            const [shareStatus, setShareStatus] = useState('');
            const [isSharedMode, setIsSharedMode] = useState(false);

            useEffect(() => {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    try {
                        let decodedData;
                        const decompressed = LZString.decompressFromEncodedURIComponent(hash);
                        if (decompressed) {
                            decodedData = JSON.parse(decompressed);
                        } else {
                            decodedData = JSON.parse(decodeURIComponent(escape(atob(hash))));
                        }
                        if (decodedData.videoUrl) setVideoUrl(decodedData.videoUrl);
                        if (decodedData.questions) setQuestions(decodedData.questions);
                        setIsSharedMode(true); 
                    } catch (e) { 
                        console.error("Линкът е невалиден или повреден", e); 
                    }
                } else {
                    const savedVideo = localStorage.getItem('vq_videoUrl');
                    const savedQuestions = localStorage.getItem('vq_questions');
                    if (savedVideo) setVideoUrl(savedVideo);
                    if (savedQuestions) setQuestions(JSON.parse(savedQuestions));
                }
            }, []);

            useEffect(() => {
                if (!isSharedMode) {
                    if (videoUrl) localStorage.setItem('vq_videoUrl', videoUrl);
                    localStorage.setItem('vq_questions', JSON.stringify(questions));
                }
            }, [videoUrl, questions, isSharedMode]);

            const generateShareLink = () => {
                const data = { videoUrl, questions };
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
                const url = `${window.location.origin}${window.location.pathname}#${compressed}`;
                navigator.clipboard.writeText(url).then(() => {
                    setShareStatus('Копирано!');
                    setTimeout(() => setShareStatus(''), 3000);
                });
            };

            const resetApp = () => {
                window.location.hash = '';
                window.location.reload();
            };

            return (
                <div className="min-h-screen">
                    <nav className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2 text-blue-600">
                            <Icons.Video />
                            <h1 className="text-xl font-extrabold text-slate-800 tracking-tight">VideoQuiz <span className="text-blue-600">Lite</span></h1>
                        </div>
                        <div className="flex gap-2 bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setView('student')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'student' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Решаване</button>
                            {!isSharedMode ? (
                                <button onClick={() => setView('teacher')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'teacher' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Дизайн</button>
                            ) : (
                                <button onClick={resetApp} className="px-3 py-2 text-xs font-bold text-slate-500 hover:text-blue-600 transition-colors flex items-center gap-1" title="Изчисти линка и създай нов тест">
                                    <Icons.Plus /> Нов
                                </button>
                            )}
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-6">
                        {view === 'student' ? (
                            <StudentInterface videoUrl={videoUrl} questions={questions} />
                        ) : (
                            !isAuthenticated ? (
                                <div className="max-w-md mx-auto mt-20 bg-white p-8 rounded-3xl shadow-xl border text-center animate-fade-in">
                                    <div className="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6"><Icons.Lock /></div>
                                    <h2 className="text-2xl font-bold mb-2">Режим Дизайн</h2>
                                    <p className="text-slate-500 text-sm mb-6">Въведете паролата за достъп до редактора</p>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Парола..." className="w-full px-4 py-3 rounded-xl border mb-4 outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
                                    <button onClick={() => password === 'admin' ? setIsAuthenticated(true) : alert('Грешна парола')} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-100">Влез в настройките</button>
                                </div>
                            ) : (
                                <TeacherDashboard questions={questions} setQuestions={setQuestions} videoUrl={videoUrl} setVideoUrl={setVideoUrl} onShare={generateShareLink} shareStatus={shareStatus} isSharedMode={isSharedMode} resetApp={resetApp} />
                            )
                        )}
                    </main>
                </div>
            );
        };

        const StudentInterface = ({ videoUrl, questions }) => {
            const playerRef = useRef(null);
            const containerRef = useRef(null);
            const [activeQuestion, setActiveQuestion] = useState(null);
            const [score, setScore] = useState(0);
            const [answeredIds, setAnsweredIds] = useState(new Set());
            const [textAnswer, setTextAnswer] = useState('');
            const [selectedOptions, setSelectedOptions] = useState([]);

            useEffect(() => {
                if (!videoUrl) return;
                const checkTime = () => {
                    if (!playerRef.current) return;
                    const time = Math.floor(playerRef.current.getTime());
                    const q = questions.find(q => q.time === time && !answeredIds.has(q.id));
                    if (q) {
                        playerRef.current.pause();
                        setActiveQuestion(q);
                        setTextAnswer('');
                        setSelectedOptions([]);
                    }
                };
                const interval = setInterval(checkTime, 500);
                return () => clearInterval(interval);
            }, [questions, answeredIds, videoUrl]);

            const submit = (correct) => {
                const points = activeQuestion.points !== undefined ? activeQuestion.points : 1;
                if (correct === true) setScore(s => s + points);
                setAnsweredIds(new Set([...answeredIds, activeQuestion.id]));
                setActiveQuestion(null);
                playerRef.current.play();
            };

            if (!videoUrl) {
                return (
                    <div className="bg-white border-2 border-dashed border-slate-200 rounded-3xl p-20 flex flex-col items-center justify-center text-center space-y-4 animate-fade-in">
                        <Icons.Alert className="text-slate-200 w-16 h-16" />
                        <h2 className="text-xl font-bold text-slate-400">Няма зареден тест</h2>
                        <p className="text-slate-400 text-sm max-w-xs">Моля, влезте в режим "Дизайн", за да добавите видео и въпроси, или отворете споделен линк.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6 animate-fade-in">
                    <div ref={containerRef} className="relative aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl border-4 border-white">
                        <MediaPlayer key={videoUrl} ref={playerRef} url={videoUrl} />
                        
                        {activeQuestion && (
                            <div className="absolute inset-0 z-40">
                                {activeQuestion.type !== 'label' && (
                                    <div className="absolute inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6">
                                        <div className="bg-white rounded-3xl p-8 max-w-xl w-full shadow-2xl animate-fade-in relative">
                                            <div className="absolute top-4 right-6 flex items-center gap-1 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                                <Icons.Star className="w-4 h-4 text-yellow-500" />
                                                {activeQuestion.points || 1} т.
                                            </div>

                                            <h3 className="text-xl font-bold mb-6 pr-12">{activeQuestion.text}</h3>
                                            {activeQuestion.type === 'single' && (
                                                <div className="space-y-3">
                                                    {activeQuestion.options.map((opt, i) => (
                                                        <button key={i} onClick={() => submit(i === activeQuestion.correct)} className="w-full text-left p-4 rounded-xl border-2 hover:border-blue-500 transition-all font-medium flex justify-between items-center group">
                                                            {opt}<div className="w-5 h-5 rounded-full border-2 border-slate-200 group-hover:border-blue-500 transition-all"></div>
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                            {activeQuestion.type === 'multiple' && (
                                                <div className="space-y-3">
                                                    {activeQuestion.options.map((opt, i) => (
                                                        <button key={i} onClick={() => setSelectedOptions(prev => prev.includes(i) ? prev.filter(x => x !== i) : [...prev, i])} className={`w-full text-left p-4 rounded-xl border-2 transition-all font-medium flex justify-between items-center group ${selectedOptions.includes(i) ? 'border-blue-500 bg-blue-50 text-blue-700' : 'hover:border-blue-500'}`}>
                                                            {opt}<div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${selectedOptions.includes(i) ? 'bg-blue-600 border-blue-600' : 'border-slate-200 group-hover:border-blue-500'}`}>{selectedOptions.includes(i) && <Icons.Check className="text-white w-3 h-3" />}</div>
                                                        </button>
                                                    ))}
                                                    <button onClick={() => {
                                                        // ФИКСИРАНА ПРОВЕРКА ЗА МНОЖЕСТВЕН ИЗБОР
                                                        const isCorrect = Array.isArray(activeQuestion.correct) && 
                                                            activeQuestion.correct.length === selectedOptions.length &&
                                                            activeQuestion.correct.every(val => selectedOptions.includes(val));
                                                        submit(isCorrect);
                                                    }} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-colors mt-2">Потвърди</button>
                                                </div>
                                            )}
                                            {activeQuestion.type === 'text' && (
                                                <div className="space-y-4">
                                                    <input value={textAnswer} onChange={e => setTextAnswer(e.target.value)} className="w-full p-4 rounded-xl border-2 outline-none focus:border-blue-500 transition-all" placeholder="Напишете вашия отговор..." />
                                                    <button onClick={() => submit(textAnswer.trim().toLowerCase() === activeQuestion.correct.toLowerCase())} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-colors">Изпрати отговор</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {activeQuestion.type === 'label' && (
                                    <div className="absolute inset-0 bg-slate-900/40">
                                        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white/90 px-6 py-3 rounded-full shadow-lg z-50 text-center animate-fade-in">
                                            <div className="flex items-center gap-2 justify-center mb-1">
                                                <Icons.Chat className="text-blue-500" />
                                                <span className="font-bold text-slate-800">Дискусия</span>
                                            </div>
                                            <p className="text-sm font-medium text-slate-600">{activeQuestion.text}</p>
                                        </div>
                                        {activeQuestion.options.map((label, i) => (
                                            <DraggableLabel key={i} text={label} containerRef={containerRef} />
                                        ))}
                                        <button 
                                            onClick={() => submit(null)} 
                                            className="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-xl transition-all active:scale-95 z-50"
                                        >
                                            Продължи (0 т.)
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border text-center">
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Прогрес на решаване</p>
                            <p className="text-3xl font-black text-slate-800">{answeredIds.size} / {questions.length}</p>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border text-center">
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Точки</p>
                            <p className="text-3xl font-black text-green-600">{score}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const TeacherDashboard = ({ questions, setQuestions, videoUrl, setVideoUrl, onShare, shareStatus, isSharedMode, resetApp }) => {
            const playerRef = useRef(null);
            const fileInputRef = useRef(null);
            const [newQ, setNewQ] = useState({ text: '', time: 0, type: 'single', options: ['', ''], correct: 0, points: 1 });
            const [editingId, setEditingId] = useState(null);
            
            const isYouTube = getYouTubeId(videoUrl);

            const handleEdit = (q) => {
                setNewQ({ ...q, points: q.points ?? 1 }); 
                setEditingId(q.id); 
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            };

            const handleSaveQuestion = () => {
                if (!newQ.text) return;
                const questionToSave = { ...newQ, points: parseInt(newQ.points) || 0 };

                if (editingId) {
                    setQuestions(questions.map(q => q.id === editingId ? { ...questionToSave, id: editingId } : q));
                    setEditingId(null);
                } else {
                    setQuestions([...questions, { ...questionToSave, id: Date.now() }]);
                }
                setNewQ({ text: '', time: 0, type: 'single', options: ['', ''], correct: 0, points: 1 });
            };

            const handleCancelEdit = () => {
                setEditingId(null);
                setNewQ({ text: '', time: 0, type: 'single', options: ['', ''], correct: 0, points: 1 });
            };

            const handleClearAll = () => {
                if (confirm('Сигурни ли сте? Това ще изтрие текущото видео и всички въпроси.')) {
                    setVideoUrl('');
                    setQuestions([]);
                    setNewQ({ text: '', time: 0, type: 'single', options: ['', ''], correct: 0, points: 1 });
                    setEditingId(null);
                    localStorage.removeItem('vq_videoUrl');
                    localStorage.removeItem('vq_questions');
                }
            };

            const handleExport = () => {
                const data = { videoUrl, questions };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'video-quiz-lesson.txt';
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.videoUrl) setVideoUrl(data.videoUrl);
                        if (data.questions) setQuestions(data.questions);
                    } catch (err) {
                        alert('Грешка при четене на файла!');
                    }
                };
                reader.readAsText(file);
                e.target.value = null; // Reset input
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade-in">
                    <div className="lg:col-span-8 space-y-6">
                        <div className="bg-white p-6 rounded-3xl border shadow-sm relative">
                            <div className="absolute top-6 right-6 flex items-center gap-2">
                                <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" accept=".txt,.json" />
                                <button 
                                    onClick={() => fileInputRef.current.click()} 
                                    className="p-2 text-slate-500 hover:text-blue-600 hover:bg-slate-100 rounded-lg transition-colors"
                                    title="Зареди от файл"
                                >
                                    <Icons.Upload />
                                </button>
                                <button 
                                    onClick={handleExport} 
                                    className="p-2 text-slate-500 hover:text-blue-600 hover:bg-slate-100 rounded-lg transition-colors"
                                    title="Запази като файл"
                                >
                                    <Icons.Download />
                                </button>
                                <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                <button 
                                    onClick={handleClearAll}
                                    className="flex items-center gap-1 text-xs font-bold text-red-500 bg-red-50 hover:bg-red-100 px-3 py-2 rounded-lg transition-colors"
                                >
                                    <Icons.Refresh /> Нов
                                </button>
                            </div>

                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                                <Icons.Video /> 
                                Видео източник
                                {isYouTube && <span className="bg-red-50 text-red-600 text-[10px] px-2 py-1 rounded-full flex items-center gap-1"><Icons.Youtube /> YouTube</span>}
                            </h2>

                            {videoUrl ? (
                                <div className="w-full aspect-video bg-black rounded-xl mb-4 overflow-hidden">
                                    <MediaPlayer key={videoUrl} ref={playerRef} url={videoUrl} />
                                </div>
                            ) : (
                                <div className="w-full aspect-video bg-slate-50 rounded-xl mb-4 flex flex-col items-center justify-center border-2 border-dashed border-slate-200">
                                    <p className="text-slate-400 text-sm mb-2">Няма въведено видео</p>
                                    <button onClick={() => setVideoUrl('https://www.youtube.com/watch?v=aqz-KE-bpKQ')} className="text-blue-600 text-xs font-bold hover:underline">
                                        Зареди YouTube пример
                                    </button>
                                </div>
                            )}
                            <div className="flex gap-2">
                                <input value={videoUrl} onChange={e => setVideoUrl(e.target.value)} className="flex-1 p-3 rounded-xl border outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="YouTube линк или .mp4 файл..." />
                            </div>
                        </div>
                        <div className="space-y-4">
                            <h2 className="text-xl font-bold px-2">Въпроси в този тест ({questions.length})</h2>
                            {questions.sort((a,b) => a.time - b.time).map(q => (
                                <div key={q.id} className={`bg-white p-4 rounded-2xl border flex justify-between items-center group hover:border-blue-200 transition-all ${editingId === q.id ? 'border-blue-500 bg-blue-50 shadow-md' : ''}`}>
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded font-mono">{q.time} сек</span>
                                            <span className={`text-[10px] uppercase font-bold tracking-wider ${q.type === 'label' ? 'text-purple-500' : 'text-blue-500'}`}>
                                                {q.type === 'single' ? 'Избор' : q.type === 'multiple' ? 'Множествен' : q.type === 'label' ? 'Етикети' : 'Текст'}
                                            </span>
                                            <span className="text-[10px] text-slate-400 font-bold bg-slate-100 px-2 rounded-full ml-1">
                                                {q.points ?? 1} т.
                                            </span>
                                            {editingId === q.id && <span className="text-[10px] font-bold text-blue-600 bg-white px-2 rounded-full animate-pulse">Редактиране...</span>}
                                        </div>
                                        <span className="font-bold text-slate-700">{q.text}</span>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleEdit(q)} className="text-slate-400 hover:text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition-all" title="Редактирай"><Icons.Edit /></button>
                                        <button onClick={() => setQuestions(questions.filter(x => x.id !== q.id))} className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-all" title="Изтрий"><Icons.Trash /></button>
                                    </div>
                                </div>
                            ))}
                            {questions.length === 0 && <div className="text-center py-10 border-2 border-dashed rounded-3xl text-slate-400">Няма добавени моменти за спиране.</div>}
                        </div>
                    </div>
                    <div className="lg:col-span-4 space-y-6">
                        <div className="bg-blue-600 p-6 rounded-3xl text-white shadow-xl">
                            <h3 className="text-lg font-bold mb-2 flex items-center gap-2">Споделяне</h3>
                            <p className="text-sm opacity-80 mb-6">Линкът автоматично включва всички промени, които правите.</p>
                            <button onClick={onShare} className="w-full bg-white text-blue-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-50 transition-all active:scale-95 disabled:opacity-50" disabled={!videoUrl}>
                                {shareStatus ? <Icons.Check className="w-5 h-5" /> : <Icons.Share />} {shareStatus || 'Копирай линк'}
                            </button>
                        </div>
                        <div className={`bg-white p-6 rounded-3xl border shadow-xl transition-all ${editingId ? 'ring-2 ring-blue-500 ring-offset-2' : ''}`}>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold flex items-center gap-2">
                                    {editingId ? 'Редактиране на въпрос' : 'Нов момент'}
                                </h3>
                                {editingId && <button onClick={handleCancelEdit} className="text-xs text-slate-400 hover:text-slate-600 bg-slate-100 px-2 py-1 rounded"><Icons.X /></button>}
                            </div>
                            
                            <div className="space-y-4">
                                <div className="flex bg-slate-100 p-1 rounded-lg gap-1 overflow-x-auto">
                                    <button onClick={() => setNewQ({...newQ, type: 'single', correct: 0, points: 1})} className={`flex-1 py-1.5 px-2 text-xs font-bold rounded-md transition-all whitespace-nowrap ${newQ.type === 'single' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Избор</button>
                                    <button onClick={() => setNewQ({...newQ, type: 'multiple', correct: [], points: 1})} className={`flex-1 py-1.5 px-2 text-xs font-bold rounded-md transition-all whitespace-nowrap ${newQ.type === 'multiple' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Множествен</button>
                                    <button onClick={() => setNewQ({...newQ, type: 'text', correct: '', points: 1})} className={`flex-1 py-1.5 px-2 text-xs font-bold rounded-md transition-all whitespace-nowrap ${newQ.type === 'text' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Текст</button>
                                    <button onClick={() => setNewQ({...newQ, type: 'label', correct: null, points: 0})} className={`flex-1 py-1.5 px-2 text-xs font-bold rounded-md transition-all whitespace-nowrap ${newQ.type === 'label' ? 'bg-white shadow text-purple-600' : 'text-slate-500'}`}>Етикети</button>
                                </div>
                                <textarea value={newQ.text} onChange={e => setNewQ({...newQ, text: e.target.value})} className="w-full p-3 border rounded-xl outline-none focus:border-blue-500 transition-all text-sm" placeholder={newQ.type === 'label' ? "Инструкция за дискусия..." : "Какъв е въпросът?"} />
                                
                                <div className="flex gap-2">
                                    <div className="flex-1">
                                        <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-wider">Време (сек)</label>
                                        <div className="flex gap-2">
                                            <input type="number" value={newQ.time} onChange={e => setNewQ({...newQ, time: parseInt(e.target.value) || 0})} className="w-full p-2 border rounded-lg text-sm font-mono" />
                                            <button 
                                                onClick={() => videoUrl && setNewQ({...newQ, time: Math.floor(playerRef.current.getTime())})} 
                                                className="px-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-100 transition-all flex items-center justify-center disabled:opacity-50"
                                                disabled={!videoUrl}
                                                title="Вземи от видеото"
                                            >
                                                <Icons.Clock className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>
                                    <div className="w-1/3">
                                        <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-wider">Точки</label>
                                        <input type="number" value={newQ.points} onChange={e => setNewQ({...newQ, points: parseInt(e.target.value) || 0})} className="w-full p-2 border rounded-lg text-sm font-mono text-center" />
                                    </div>
                                </div>
                                
                                {(newQ.type === 'single' || newQ.type === 'multiple') && (
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-bold text-slate-400 block uppercase tracking-wider">Опции (маркирайте верните)</label>
                                        {newQ.options.map((o, i) => (
                                            <div key={i} className="flex gap-2 items-center">
                                                {newQ.type === 'single' ? (
                                                    <input type="radio" checked={newQ.correct === i} onChange={() => setNewQ({...newQ, correct: i})} className="w-4 h-4 cursor-pointer accent-blue-600" />
                                                ) : (
                                                    <input 
                                                        type="checkbox" 
                                                        checked={Array.isArray(newQ.correct) ? newQ.correct.includes(i) : false} 
                                                        onChange={() => {
                                                            // ФИКСИРАНА ЛОГИКА ЗА CHECKBOX
                                                            const currentCorrect = Array.isArray(newQ.correct) ? newQ.correct : [];
                                                            const newCorrect = currentCorrect.includes(i) 
                                                                ? currentCorrect.filter(c => c !== i) 
                                                                : [...currentCorrect, i];
                                                            setNewQ({...newQ, correct: newCorrect});
                                                        }} 
                                                        className="w-4 h-4 cursor-pointer accent-blue-600" 
                                                    />
                                                )}
                                                <input value={o} onChange={e => { const opts = [...newQ.options]; opts[i] = e.target.value; setNewQ({...newQ, options: opts}); }} className="flex-1 p-2 border rounded-lg text-xs outline-none focus:border-blue-300 transition-all" placeholder={`Опция ${i+1}`} />
                                            </div>
                                        ))}
                                        <button onClick={() => setNewQ({...newQ, options: [...newQ.options, '']})} className="text-[10px] text-blue-600 font-bold">+ Добави още</button>
                                    </div>
                                )}

                                {newQ.type === 'text' && (
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-wider">Очакван верен отговор</label>
                                        <input value={newQ.correct} onChange={e => setNewQ({...newQ, correct: e.target.value})} className="w-full p-2 border rounded-lg text-sm outline-none focus:border-blue-300" placeholder="Напр. Париж" />
                                    </div>
                                )}
                                
                                <button 
                                    onClick={handleSaveQuestion} 
                                    className={`w-full text-white py-3 rounded-xl font-bold transition-all shadow-lg active:scale-95 disabled:opacity-50 ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-800 hover:bg-slate-900'}`}
                                    disabled={!videoUrl}
                                >
                                    {editingId ? 'Запази промените' : 'Добави към теста'}
                                </button>
                                {editingId && (
                                    <button onClick={handleCancelEdit} className="w-full py-2 text-xs font-bold text-slate-500 hover:text-slate-700">Отказ</button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
