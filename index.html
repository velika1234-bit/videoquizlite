<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoQuiz Lite</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Икони
        const Icons = {
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>,
            Check: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="opacity-20"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Clock: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        const App = () => {
            const [view, setView] = useState('student');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [videoUrl, setVideoUrl] = useState('');
            const [questions, setQuestions] = useState([]);
            const [shareStatus, setShareStatus] = useState('');

            useEffect(() => {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    try {
                        const decodedData = JSON.parse(decodeURIComponent(escape(atob(hash))));
                        if (decodedData.videoUrl) setVideoUrl(decodedData.videoUrl);
                        if (decodedData.questions) setQuestions(decodedData.questions);
                    } catch (e) { console.error("Линкът е невалиден"); }
                } else {
                    const savedVideo = localStorage.getItem('vq_videoUrl');
                    const savedQuestions = localStorage.getItem('vq_questions');
                    if (savedVideo) setVideoUrl(savedVideo);
                    if (savedQuestions) setQuestions(JSON.parse(savedQuestions));
                }
            }, []);

            useEffect(() => {
                if (videoUrl) localStorage.setItem('vq_videoUrl', videoUrl);
                if (questions.length > 0) localStorage.setItem('vq_questions', JSON.stringify(questions));
            }, [videoUrl, questions]);

            const generateShareLink = () => {
                const data = { videoUrl, questions };
                const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
                const url = `${window.location.origin}${window.location.pathname}#${encoded}`;
                navigator.clipboard.writeText(url).then(() => {
                    setShareStatus('Копирано!');
                    setTimeout(() => setShareStatus(''), 3000);
                });
            };

            return (
                <div className="min-h-screen">
                    <nav className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2 text-blue-600">
                            <Icons.Video />
                            <h1 className="text-xl font-extrabold text-slate-800 tracking-tight">VideoQuiz <span className="text-blue-600">Lite</span></h1>
                        </div>
                        <div className="flex gap-2 bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setView('student')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'student' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Решаване</button>
                            <button onClick={() => setView('teacher')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'teacher' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Дизайн</button>
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-6">
                        {view === 'student' ? (
                            <StudentInterface videoUrl={videoUrl} questions={questions} />
                        ) : (
                            !isAuthenticated ? (
                                <div className="max-w-md mx-auto mt-20 bg-white p-8 rounded-3xl shadow-xl border text-center animate-fade-in">
                                    <div className="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6"><Icons.Lock /></div>
                                    <h2 className="text-2xl font-bold mb-2">Режим Дизайн</h2>
                                    <p className="text-slate-500 text-sm mb-6">Въведете паролата за достъп до редактора</p>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        placeholder="Парола..." 
                                        className="w-full px-4 py-3 rounded-xl border mb-4 outline-none focus:ring-2 focus:ring-blue-500 transition-all" 
                                    />
                                    <button 
                                        onClick={() => password === 'admin' ? setIsAuthenticated(true) : alert('Грешна парола')} 
                                        className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-100"
                                    >
                                        Влез в настройките
                                    </button>
                                </div>
                            ) : (
                                <TeacherDashboard questions={questions} setQuestions={setQuestions} videoUrl={videoUrl} setVideoUrl={setVideoUrl} onShare={generateShareLink} shareStatus={shareStatus} />
                            )
                        )}
                    </main>
                </div>
            );
        };

        const StudentInterface = ({ videoUrl, questions }) => {
            const videoRef = useRef(null);
            const [activeQuestion, setActiveQuestion] = useState(null);
            const [score, setScore] = useState(0);
            const [answeredIds, setAnsweredIds] = useState(new Set());
            const [textAnswer, setTextAnswer] = useState('');
            const [selectedOptions, setSelectedOptions] = useState([]);

            useEffect(() => {
                if (!videoUrl) return;
                const checkTime = () => {
                    if (!videoRef.current) return;
                    const time = Math.floor(videoRef.current.currentTime);
                    const q = questions.find(q => q.time === time && !answeredIds.has(q.id));
                    if (q) {
                        videoRef.current.pause();
                        setActiveQuestion(q);
                        setTextAnswer('');
                        setSelectedOptions([]);
                    }
                };
                const interval = setInterval(checkTime, 500);
                return () => clearInterval(interval);
            }, [questions, answeredIds, videoUrl]);

            const submit = (correct) => {
                if (correct) setScore(s => s + 1);
                setAnsweredIds(new Set([...answeredIds, activeQuestion.id]));
                setActiveQuestion(null);
                videoRef.current.play();
            };

            if (!videoUrl) {
                return (
                    <div className="bg-white border-2 border-dashed border-slate-200 rounded-3xl p-20 flex flex-col items-center justify-center text-center space-y-4 animate-fade-in">
                        <Icons.Alert />
                        <h2 className="text-xl font-bold text-slate-400">Няма зареден тест</h2>
                        <p className="text-slate-400 text-sm max-w-xs">Моля, влезте в режим "Дизайн", за да добавите видео и въпроси, или отворете споделен линк.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="relative aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl border-4 border-white">
                        <video key={videoUrl} ref={videoRef} src={videoUrl} controls className="w-full h-full" />
                        {activeQuestion && (
                            <div className="absolute inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6 z-40">
                                <div className="bg-white rounded-3xl p-8 max-w-xl w-full shadow-2xl animate-fade-in">
                                    <h3 className="text-xl font-bold mb-6">{activeQuestion.text}</h3>
                                    
                                    {/* Един верен отговор */}
                                    {activeQuestion.type === 'single' && (
                                        <div className="space-y-3">
                                            {activeQuestion.options.map((opt, i) => (
                                                <button key={i} onClick={() => submit(i === activeQuestion.correct)} className="w-full text-left p-4 rounded-xl border-2 hover:border-blue-500 transition-all font-medium flex justify-between items-center group">
                                                    {opt}
                                                    <div className="w-5 h-5 rounded-full border-2 border-slate-200 group-hover:border-blue-500 transition-all"></div>
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    {/* Множествен отговор */}
                                    {activeQuestion.type === 'multiple' && (
                                        <div className="space-y-3">
                                            {activeQuestion.options.map((opt, i) => (
                                                <button key={i} onClick={() => setSelectedOptions(prev => prev.includes(i) ? prev.filter(x => x !== i) : [...prev, i])} className={`w-full text-left p-4 rounded-xl border-2 transition-all font-medium flex justify-between items-center group ${selectedOptions.includes(i) ? 'border-blue-500 bg-blue-50 text-blue-700' : 'hover:border-blue-500'}`}>
                                                    {opt}
                                                    <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${selectedOptions.includes(i) ? 'bg-blue-600 border-blue-600' : 'border-slate-200 group-hover:border-blue-500'}`}>
                                                        {selectedOptions.includes(i) && <Icons.Check className="text-white w-3 h-3" />}
                                                    </div>
                                                </button>
                                            ))}
                                            <button onClick={() => {
                                                const correctSorted = JSON.stringify(activeQuestion.correct.sort());
                                                const selectedSorted = JSON.stringify(selectedOptions.sort());
                                                submit(correctSorted === selectedSorted);
                                            }} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-colors mt-2">Потвърди</button>
                                        </div>
                                    )}

                                    {/* Свободен текст */}
                                    {activeQuestion.type === 'text' && (
                                        <div className="space-y-4">
                                            <input value={textAnswer} onChange={e => setTextAnswer(e.target.value)} className="w-full p-4 rounded-xl border-2 outline-none focus:border-blue-500 transition-all" placeholder="Напишете вашия отговор..." />
                                            <button onClick={() => submit(textAnswer.trim().toLowerCase() === activeQuestion.correct.toLowerCase())} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-colors">Изпрати отговор</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border text-center">
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Прогрес на решаване</p>
                            <p className="text-3xl font-black text-slate-800">{answeredIds.size} / {questions.length}</p>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border text-center">
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Верни отговори</p>
                            <p className="text-3xl font-black text-green-600">{score}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const TeacherDashboard = ({ questions, setQuestions, videoUrl, setVideoUrl, onShare, shareStatus }) => {
            const videoRef = useRef(null);
            const [newQ, setNewQ] = useState({ text: '', time: 0, type: 'single', options: ['', ''], correct: 0 });

            return (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade-in">
                    <div className="lg:col-span-8 space-y-6">
                        <div className="bg-white p-6 rounded-3xl border shadow-sm">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icons.Video /> Видео източник</h2>
                            {videoUrl ? (
                                <video ref={videoRef} src={videoUrl} controls className="w-full aspect-video bg-black rounded-xl mb-4" />
                            ) : (
                                <div className="w-full aspect-video bg-slate-100 rounded-xl mb-4 flex items-center justify-center border-2 border-dashed border-slate-200">
                                    <p className="text-slate-400 text-sm">Няма въведено видео</p>
                                </div>
                            )}
                            <div className="flex gap-2">
                                <input value={videoUrl} onChange={e => setVideoUrl(e.target.value)} className="flex-1 p-3 rounded-xl border outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Поставете линк към .mp4 видео..." />
                            </div>
                        </div>
                        <div className="space-y-4">
                            <h2 className="text-xl font-bold px-2">Въпроси в този тест ({questions.length})</h2>
                            {questions.sort((a,b) => a.time - b.time).map(q => (
                                <div key={q.id} className="bg-white p-4 rounded-2xl border flex justify-between items-center group hover:border-blue-200 transition-all">
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded font-mono">{q.time} сек</span>
                                            <span className="text-[10px] uppercase font-bold text-blue-500 tracking-wider">
                                                {q.type === 'single' ? 'Избор' : q.type === 'multiple' ? 'Множествен' : 'Текст'}
                                            </span>
                                        </div>
                                        <span className="font-bold text-slate-700">{q.text}</span>
                                    </div>
                                    <button onClick={() => setQuestions(questions.filter(x => x.id !== q.id))} className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-all"><Icons.Trash /></button>
                                </div>
                            ))}
                            {questions.length === 0 && <div className="text-center py-10 border-2 border-dashed rounded-3xl text-slate-400">Няма добавени моменти за спиране.</div>}
                        </div>
                    </div>
                    <div className="lg:col-span-4 space-y-6">
                        <div className="bg-blue-600 p-6 rounded-3xl text-white shadow-xl">
                            <h3 className="text-lg font-bold mb-2 flex items-center gap-2">Споделяне</h3>
                            <p className="text-sm opacity-80 mb-6">Линкът автоматично включва всички промени, които правите.</p>
                            <button onClick={onShare} className="w-full bg-white text-blue-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-50 transition-all active:scale-95 disabled:opacity-50" disabled={!videoUrl}>
                                {shareStatus ? <Icons.Check className="w-5 h-5" /> : <Icons.Share />} {shareStatus || 'Копирай линк'}
                            </button>
                        </div>
                        <div className="bg-white p-6 rounded-3xl border shadow-xl">
                            <h3 className="font-bold mb-4 flex items-center gap-2">Нов момент</h3>
                            <div className="space-y-4">
                                <div className="flex bg-slate-100 p-1 rounded-lg gap-1">
                                    <button onClick={() => setNewQ({...newQ, type: 'single', correct: 0})} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${newQ.type === 'single' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Избор</button>
                                    <button onClick={() => setNewQ({...newQ, type: 'multiple', correct: []})} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${newQ.type === 'multiple' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Множествен</button>
                                    <button onClick={() => setNewQ({...newQ, type: 'text', correct: ''})} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${newQ.type === 'text' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Свободен</button>
                                </div>
                                <textarea value={newQ.text} onChange={e => setNewQ({...newQ, text: e.target.value})} className="w-full p-3 border rounded-xl outline-none focus:border-blue-500 transition-all text-sm" placeholder="Какъв е въпросът?" />
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-wider">Време за спиране</label>
                                    <div className="flex gap-2">
                                        <input type="number" value={newQ.time} onChange={e => setNewQ({...newQ, time: parseInt(e.target.value) || 0})} className="flex-1 p-2 border rounded-lg text-sm font-mono" />
                                        <button 
                                            onClick={() => videoUrl && setNewQ({...newQ, time: Math.floor(videoRef.current.currentTime)})} 
                                            className="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-100 transition-all flex items-center gap-1 disabled:opacity-50"
                                            disabled={!videoUrl}
                                        >
                                            <Icons.Clock className="w-3 h-3" /> Вземи от видеото
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Опции за Single и Multiple */}
                                {(newQ.type === 'single' || newQ.type === 'multiple') && (
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-bold text-slate-400 block uppercase tracking-wider">Опции (маркирайте верните)</label>
                                        {newQ.options.map((o, i) => (
                                            <div key={i} className="flex gap-2 items-center">
                                                {newQ.type === 'single' ? (
                                                    <input type="radio" checked={newQ.correct === i} onChange={() => setNewQ({...newQ, correct: i})} className="w-4 h-4 cursor-pointer accent-blue-600" />
                                                ) : (
                                                    <input type="checkbox" checked={newQ.correct.includes(i)} onChange={() => {
                                                        const newCorrect = newQ.correct.includes(i) ? newQ.correct.filter(c => c !== i) : [...newQ.correct, i];
                                                        setNewQ({...newQ, correct: newCorrect});
                                                    }} className="w-4 h-4 cursor-pointer accent-blue-600" />
                                                )}
                                                <input value={o} onChange={e => { const opts = [...newQ.options]; opts[i] = e.target.value; setNewQ({...newQ, options: opts}); }} className="flex-1 p-2 border rounded-lg text-xs outline-none focus:border-blue-300 transition-all" placeholder={`Опция ${i+1}`} />
                                            </div>
                                        ))}
                                        <button onClick={() => setNewQ({...newQ, options: [...newQ.options, '']})} className="text-[10px] text-blue-600 font-bold">+ Добави още</button>
                                    </div>
                                )}

                                {/* Свободен текст */}
                                {newQ.type === 'text' && (
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-wider">Очакван верен отговор</label>
                                        <input value={newQ.correct} onChange={e => setNewQ({...newQ, correct: e.target.value})} className="w-full p-2 border rounded-lg text-sm outline-none focus:border-blue-300" placeholder="Напр. Париж" />
                                    </div>
                                )}
                                <button onClick={() => { setQuestions([...questions, {...newQ, id: Date.now()}]); setNewQ({ text: '', time: 0, type: 'single', options: ['', ''], correct: 0 }); }} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-all shadow-lg active:scale-95 disabled:opacity-50" disabled={!videoUrl}>Добави към теста</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
